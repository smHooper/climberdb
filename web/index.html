<!DOCTYPE html>
<html>
<head>
	<meta charset='utf-8'>
	<meta name="viewport" content="width=device-width,height=device-height, user-scalable=no" />
	<title>DENA Climbing Permit Portal</title>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.0/jquery.min.js"></script>
	
	<!--bootstap-->
	<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css"/>
	<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

	<!--fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Lato:ital,wght@0,300;0,400;0,700;1,400&display=swap" rel="stylesheet">

	<link rel="stylesheet" href="css/climberdb.css">
	<link rel="stylesheet" href="css/climberdb-index.css">
</head>

<body>
	<div id="sign-in-form-container">
		<div class="field-container">
			<input id="username-input" class="input-field" name="username" placeholder="Username" autocomplete="off">
			<label class="field-label" for="username-input">Username</label>
		</div>
		<div class="field-container default-field">
			<input id="password-input" class="input-field" name="password" type="password" placeholder="Password">
			<label class="field-label" for="password-input">Password</label>
		</div>
		<div class="invalid-password-message-container">
			<label id="incorrect-password-message" class="invalid-password-message hidden" aria-hidden="true">The password you entered is incorrect</label>
			<label id="empty-password-message" class="invalid-password-message hidden" aria-hidden="true">You must enter a password to sign in</label>
		</div>
		<div class="field-container request-field hidden" aria-hidden=true>
			<input id="first-name-input" class="input-field" name="first_name" placeholder="Fist name" autocomplete="off">
			<label class="field-label" for="password-input">First name</label>
		</div>
		<div class="field-container request-field hidden" aria-hidden=true>
			<input id="last-name-input" class="input-field" name="last_name" placeholder="Last name" autocomplete="off">
			<label class="field-label" for="password-input">Last name</label>
		</div>
		<div id="sign-in-form-footer" class="field-container col">
			<div class="field-container default-container">
				<div class="field-container checkbox-field-container col-6">
					<label class="checkmark-container">
						<input id="retain-login-checkbox" class="input-field input-checkbox" type="checkbox" name="retain-login">
						<span class="checkmark data-input-checkmark"></span>
						<!-- stay signed in -->
					</label>
					<label class="field-label checkbox-label" for="retain-login-checkbox">Stay signed in</label>
				</div>
				<button id="sign-in-button" class="generic-button index-button" data-target="dashboard.html">sign in</button>
			</div>

			<div class="field-container request-access-container">
				<button id="hide-request-access-button" class="generic-button index-button request-access-button hidden" aria-hidden=true>back to sign-in</button>
				<button id="request-access-button" class="generic-button index-button request-access-button hidden" aria-hidden=true>request access</button>
			</div>
			<div id="request-access-toggle-button-container" class="field-container">
				<button class="text-only-button">No account? No problem! Request access here</button>
			</div>
		</div>

	</div>
	
	<script src="js/climberdb.js"></script>
	<script src="js/index.js"></script>

	<script>
		var climberDB;
		$(document).ready(function(){
			climberDB = new ClimberDBIndex();
			climberDB.init();

			/*// If the user was bounced back to the sign-in page after trying to visit another page, 
			//	the URL should have a query with the 
			if (window.location.search.length) {
				const params = climberDB.parseURLQueryString();
				if ('referer' in params) {
					$('#sign-in-button').data('target', encodeURI(params.referer));
				}
			}

			$.when(...climberDB.init({addMenu: false}))
				.done(function(resultString) {
					// If the user logged in before and their session is still active, go to the home page
					const username = climberDB.userInfo.ad_username;
					if (climberDB.loginInfo[username]) {
						if (climberDB.loginInfo[username].expiration > new Date().getTime()) {
							window.location.href = 'dashboard.html';
						}
					} 
					if (Object.keys(climberDB.userInfo).length) {
						$('#username-input').val(climberDB.userInfo.ad_username);
						$('#password-input').focus();
						//$('#request-access-toggle-button-container').ariaHide(true);
					}
				}); 

			$('#password-input').keydown(() => {
				$('#password-input').removeClass('invalid');
				$('.invalid-password-message').ariaHide(true);
			});

			// Show the "request access" fields when the button is clicked
			$('#request-access-toggle-button-container button').click((e) => {
				$('.default-field').ariaHide(true);
				$('#sign-in-button').ariaHide(true);
				$('#retain-login-checkbox').closest('.field-container').ariaHide(true);
				$(e.target).ariaHide(true);

				$('.request-field, #request-access-button').ariaHide(false);
			});

			$('#sign-in-button').click((e) => {
				// Hide in case the user didn't enter anything and clicked the sign-in button
				$('.invalid-password-message').ariaHide(true);

				const password = $('#password-input').val();
				if (password.length === 0) {
					$('#empty-password-message').ariaHide(false);
					$('#password-input').addClass('invalid')
						.val('')
						.focus();
					return;
				}

				climberDB.verifyPassword(password)
					.done(isValid => {
						if (!isValid) {
							//showModal('Password incorrect', 'Incorrect password');
							$('#incorrect-password-message').ariaHide(false);
							$('#password-input').addClass('invalid')
								.val('')
								.focus();
						} else {
							const stayLoggedIn = $('#retain-login-checkbox').prop('checked');
							const expiration = (new Date()).getTime() + 
								(stayLoggedIn ? 
									(1000 * 60 * 60 * 24 * 7) : // lasts 7 days 
									(1000 * 60 * 60) // lasts 1 hour
								); 
							climberDB.loginInfo = {username: climberDB.userInfo.ad_username, expiration: expiration}
							window.localStorage.setItem('login', JSON.stringify(climberDB.loginInfo));
							window.location.href = $(e.target).data('target');
						}
					});
			});*/


		});
	</script>

</body>



</html>